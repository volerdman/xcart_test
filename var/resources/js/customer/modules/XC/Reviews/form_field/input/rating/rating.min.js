function VoteBarController(base){this.callSupermethod('constructor',arguments);var form=jQuery(this.base).closest('form').get(0);if(form)this.productId=jQuery('input[name=product_id]',form).eq(0).val();if(this.productId){this.returnTarget=jQuery('input[name=return_target]',form).eq(0).val();this.block=new VoteBarView(this.base,this.productId,this.returnTarget)}};extend(VoteBarController,AController);VoteBarController.prototype.name='VoteBarController';VoteBarController.prototype.findPattern='.product-average-rating';VoteBarController.prototype.block=null;VoteBarController.prototype.buttonsBlock=null;VoteBarController.prototype.initialize=function(){var o=this;this.base.bind('reload',function(event,box){event.stopImmediatePropagation();o.bind(box)})}
function VoteBarClick(obj){if(!obj._rating)obj._rating=parseInt(jQuery(obj).attr('class').match(/\d+/));jQuery(obj).closest('.vote-bar.editable').find('input[name=rating]').val(obj._rating);mainObj=jQuery(obj).closest('.vote-bar.editable').get(0);mainObj._rating=obj._rating;return false}
function VoteBarView(base,productId,returnTarget){this.callSupermethod('constructor',arguments);this.productId=productId;this.returnTarget=returnTarget;this.linkClickHandler=function(event){event.stopPropagation();return false}};extend(VoteBarView,ALoadable);VoteBarView.prototype.productId=null;VoteBarView.prototype.returnTarget=null;VoteBarView.prototype.rating=null;VoteBarView.prototype.shadeWidget=true;VoteBarView.prototype.widgetTarget='review';VoteBarView.prototype.widgetClass='\\XLite\\Module\\XC\\Reviews\\View\\AverageRating';VoteBarView.prototype.prevFormActionValue='';VoteBarView.prototype.prevFormActionInput=null;VoteBarView.prototype.prevShadeWidget=null;VoteBarView.prototype.postprocess=function(isSuccess,initial){this.callSupermethod('postprocess',arguments);if(isSuccess){var o=this,widgetClass=jQuery('input[name=target_widget]',o.base).eq(0).val();if(widgetClass)this.widgetClass=widgetClass;jQuery(this.base).find('.vote-bar.editable .stars-row.hovered .star-single').bind('click',function(event){VoteBarClick(this);return o.rateProduct(event,jQuery(this))});jQuery(this.base).bind('re-load',_.throttle(function(event){o.load()},1e3,{trailing:false}));this.base.closest('form').eq(0).commonController('bindElements')}};VoteBarView.prototype.getParams=function(params){params=this.callSupermethod('getParams',arguments);params.product_id=this.productId;if(this.widgetMode)params.widgetMode=this.widgetMode;return params};VoteBarView.prototype.rateProduct=_.throttle(function(event,block){var form=jQuery(block).closest('.product-average-rating'),rating=jQuery('input[name=rating]',form).eq(0).val();this.rating=rating;var productId=jQuery(block).closest('form').find('input[name=product_id]').eq(0).val();if(productId)this.productId=productId;var widgetMode=jQuery(block).closest('form').find('input[name=widgetMode]').eq(0).val();if(widgetMode)this.widgetMode=widgetMode;var blocksThatNeedToBeRefreshed;if(productId){blocksThatNeedToBeRefreshed=jQuery('input[name="product_id"]').filter(function(){return($(this).val()==productId)}).closest('form').filter(function(){return($(this).find(VoteBarController.prototype.findPattern).length>0)})}else blocksThatNeedToBeRefreshed=jQuery(block).closest('form');core.post(URLHandler.buildURL({target:'review',action:'rate'}),function(){jQuery(VoteBarController.prototype.findPattern,blocksThatNeedToBeRefreshed).trigger('re-load')},{product_id:productId,rating:rating});return false},1e3,{trailing:false});VoteBarView.prototype.postprocessRateProduct=function(XMLHttpRequest,textStatus,data,isValid){};core.autoload(VoteBarController);core.bind('list.products.postprocess',function(){core.autoload(VoteBarController)});core.bind('block.product.details.postprocess',function(){core.autoload(VoteBarController)});CommonForm.elementControllers.push({pattern:'.vote-bar.editable .stars-row.hovered .star-single',handler:function(){jQuery(this).hover(function(){if(!this._previous)this._previous=jQuery(this).prevAll();this._previous.each(function(index){jQuery(this).addClass('over')});jQuery(this).addClass('over')},function(){if(!this._previous)this._previous=jQuery(this).prevAll();this._previous.each(function(index){jQuery(this).removeClass('over')});jQuery(this).removeClass('over')}).click(function(){return VoteBarClick(this)})}});CommonForm.elementControllers.push({pattern:'.vote-bar.editable',handler:function(){jQuery(this).hover(function(){jQuery('.stars-row.hovered',this).show()},function(){if(!this._rating){if(!this._previous)this._previous=jQuery(this).children('.star-single');this._previous.each(function(index){jQuery(this).removeClass('over')});jQuery('.stars-row.hovered',this).hide()}else{var rating=this._rating;jQuery('.stars-row.hovered',this).find('.star-single').each(function(index){var j=parseInt(jQuery(this).attr('class').match(/\d+/));if(j>rating){jQuery(this).removeClass('over')}else jQuery(this).addClass('over')})}})}});CommonForm.elementControllers.push({pattern:'div.icon-help',handler:function(){var $tooltip=jQuery('#'+jQuery(this).attr('id')+'_tooltip');jQuery(this).hover(function(){$tooltip.css({display:'block'})},function(){$tooltip.css({display:'none'})})}})